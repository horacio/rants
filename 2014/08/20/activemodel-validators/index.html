<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="description" content='Posts about Ruby, Clojure, web development, and other geeky topics.'>
    <meta name="viewport" content='width=device-width,initial-scale=1'>
    <title>svankmajer's blog - ActiveModel validations</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="../../../../stylesheets/all.css" rel="stylesheet" type="text/css" />
    <link href='https://fonts.googleapis.com/css?family=Oxygen:400,300,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Amatic+SC' rel='stylesheet' type='text/css'>
    <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png">
    <link rel="icon" type="image/png" href="/images/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="/images/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
  </head>
  <body>
    <div id="main" role="main">
      <nav>
  <ul>
    <li>
      <a class="blog-title" href="/">dead waters rise higher than your mind</a>
    </li>
    <li>
      <div class="sub-menu">
        <ul>
          <li><a href="/about">Who?</a></li>
          <li><a href="/links#reading">Reading</a></li>
          <li><a href="/links#listening">Listening</a></li>
          <li><a href="/links#watching">Watching</a></li>
        </ul>
      </div>
    <li>
  </ul>
</nav>

        <section>
    <article>
      <div class="post-header">
        <h1>
          <a href="/2014/08/20/activemodel-validators/">ActiveModel validations</a>
        </h1>
        <small>
          Aug 20, 2014
          on rails, learning
        </small>
      </div>
      <div class="corpus">
        <p>Yesterday, I fired up a console and started to code a <a href="http://chimera.labs.oreilly.com/books/1234000001813/ch05.html#breakable_toys">breakable toy</a> to see if I could drive its development using integration test driven development, which I haven&#39;t yet exercised properly. It&#39;s called Luego (&#39;Later&#39; in Spanish) and is, simply, a Pocket clone. I love <a href="https://getpocket.com/about">Pocket</a>. Last year, I was in the top 5% of readers in Pocket. I expect similar results for this year. It is an indispensable tool to me, like <a href="https://evernote.com/">Evernote</a> and <a href="https://basecamp.com/">Basecamp</a>, two other great products I use daily. So I wanted to think about how would I make my own Pocket, putting in practice what I&#39;ve learned so far about Test-Driven Development. </p>

<p>I sat down for a few hours and wrote down how Pocket could be designed at a ridiculously high level. Now, I would&#39;ve loved to run an adapted version of a <a href="http://robots.thoughtbot.com/the-product-design-sprint">Product Design Sprint</a> for this side-project, but I didn&#39;t, because I thought it would be too much. It would&#39;ve been. So, just pencil and paper, lots of fresh water and winter sunlight, and the unstoppable purring of my cats. It was a tough but pedagogical experience, and I think it has greatly improved my web application development process.</p>

<p>I know is hard to conceive at this point, but this blog post isn&#39;t about the whole design &amp; implementation process (mayhaps in the next post, who knows) but about something I&#39;ve learned about custom validations of ActiveRecord models.</p>

<p>In a nutshell, model-level ActiveRecord validations check your object&#39;s state before it hits the database to ensure only valid data gets saved. This means, merely, that when you run <code>save</code> on your ActiveRecord model instance, all configured validations are triggered, returning true if all of them passed or false if they didn&#39;t; if they didn&#39;t, you call call <code>errors.messages</code> to see a detail of those validation errors. As you can see, validations are very useful, very low cost (i.e. really easy to test and maintain) and really easy to use.</p>

<p>Rails has lots of common, pre-defined validation helpers (like <code>presence</code>, <code>uniqueness</code>, <code>length</code>, etc.), but also gives you the possibility to define your own custom validators and validation methods. I&#39;ve used pre-defined validators in my previous Rails applications, but I never really needed a custom solution for some kind of complex validation&hellip; until now (or that&#39;s what I thought initially). So I went straight to the <a href="http://guides.rubyonrails.org/">Rails guides</a>, which are excellent resources, and started reading about the different ways I could implement them.</p>

<p>Rails offers two ways to implement custom validation: <strong>custom validators</strong> and <strong>custom validation methods</strong>. Custom validators are classes that extend <code>ActiveModel::Validator</code> and implement a <code>validate(record)</code> method. You can use this validator calling <code>validates_with :my_custom_validator</code> in your model class. Here is a code sample:</p>
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyCustomValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="c1"># this is where you perform your validation</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>So, in your model class, you call the validator like this:</p>
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>

   <span class="c1"># other validations</span>
   <span class="n">validates_with</span> <span class="ss">:my_custom_validator</span>

   <span class="c1"># the rest of your awesome class</span>
<span class="k">end</span>
</code></pre>

<p>Neat, eh?</p>

<p>You could add your custom validators in <code>app/validators</code> and they will be automatically loaded on start-up.</p>

<p>You could also check specific attributes of your records using <code>ActiveModel::EachValidator</code> which must implement a <code>validate_each(record, attribute, value)</code> method. Or, you could use a custom validation method registering it with <code>validate</code> like this:</p>
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validate</span> <span class="ss">:inside_opening_hours?</span>

  <span class="k">def</span> <span class="nf">inside_opening_hours?</span>
     <span class="c1"># here you perform your needed validations</span>
     <span class="c1"># ... add some errors if conditions are not met!</span>
     <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:taken_at</span><span class="p">,</span> <span class="s2">"can't take order this late"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>You should totally check the <a href="http://guides.rubyonrails.org/active_record_validations.html">Active Record Validations</a> guide in the Rails Guides website. I wholeheartedly recommend it.</p>

      </div>
    </article>
  </section>

      <footer>
  <div>
    <p>
      Follow me online on <a href="https://twitter.com/5vankmajer">Twitter</a> and <a href="https://github.com/svankmajer">GitHub</a>.
    </p>
  </div>
  <ul class="large-column">
    <li><h5 class="heading">Recent articles</h5></li>
    <li>
      <ol>
          <li>
            <a href="../../25/old-self/">Old self</a>
            <span>Aug 25</span>
          </li>
          <li>
            <a href="./">ActiveModel validations</a>
            <span>Aug 20</span>
          </li>
          <li>
            <a href="../../../06/26/rake-0-9/">Rake 0.9</a>
            <span>Jun 26</span>
          </li>
          <li>
            <a href="../../../06/04/git-stash/">Git - Stashing (annex)</a>
            <span>Jun  4</span>
          </li>
      </ol>
    </li>
  </ul>
  <ul class="small-column">
    <li><h5 class="heading">Tags</h5></li>
    <li>
      <ol>
          <li><a href="/tags/learning/">learning (2)</a></li>
          <li><a href="/tags/programming/">programming (2)</a></li>
          <li><a href="/tags/open-government/">open government (1)</a></li>
          <li><a href="/tags/life/">life (1)</a></li>
      </ol>
    </li>
  <ul>
</footer>

    </div>
  </body>
</html>
